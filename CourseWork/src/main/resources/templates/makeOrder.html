<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
    <meta charset="UTF-8">
    <title>OrderPage</title>
    <style>
        body {
            background-color: #FF8C00;
            font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
        }
        input {
            font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
            padding: 5px;
            margin: 10px;
            border: 2px solid black;
            background-color: white;
            border-radius: 15px;
        }
        .order-form {
            height: 450px;
            width: 100%;
        }
        #map {
            height: 100%;
            width: 40%;
            float: left;
            border: solid 10px #FFD700;
            border-radius: 20px;
        }
        form {
            float: left;
            width: 55%;
            padding: 5px 5px 0px 5px;
            background: #FFD700;
            color: black;
            border: 8px solid #FF8C00;
            border-radius: 20px;
            margin: 0px 10px 0px 10px;
            height: 100%;
        }
    </style>
    <script>
        function initMap() {
            var directionsService = new google.maps.DirectionsService();
            var directionsRenderer = new google.maps.DirectionsRenderer();
            var moscow = new google.maps.LatLng(55.753501570096276, 37.61904097674664);
            var mapOptions = {zoom:7, center: moscow}
            var map = new google.maps.Map(document.getElementById('map'), mapOptions);
            directionsRenderer.setMap(map);
            const onChangeHandler = function () {
                if (document.getElementById("addressFrom").value != "" && document.getElementById("addressTo").value != "") {
                    calculateAndDisplayRoute(directionsService, directionsRenderer);
                }
            };
            const onChangeNumberOfWorkers = function () {
                document.getElementById("price").setAttribute('value', Number(document.getElementById("numberOfWorkers").value)*2000+Number(Math.ceil(document.getElementById("distance").value.replace(',', '.').split(' ')[0]))*100);
            };
            document.getElementById("numberOfWorkers").addEventListener("change", onChangeNumberOfWorkers);
            document.getElementById("addressFrom").addEventListener("change", onChangeHandler);
            document.getElementById("addressTo").addEventListener("change", onChangeHandler);
        }

        function calculateAndDisplayRoute(directionsService, directionsRenderer) {
            directionsService.route(
            {
                origin: document.getElementById("addressFrom").value,
                destination: document.getElementById("addressTo").value,
                travelMode: google.maps.TravelMode.DRIVING,
            },
                (response, status) => {
                    if (status === "OK") {
                        directionsRenderer.setDirections(response);
                        var point = response.routes[0].legs[0];
                        document.getElementById("distance").setAttribute('value', point.distance.text);
                        document.getElementById("duration").setAttribute('value', point.duration.text);
                        document.getElementById("price").setAttribute('value', Number(document.getElementById("numberOfWorkers").value)*2000+Number(Math.ceil(point.distance.text.replace(',', '.').split(' ')[0]))*100);
                        document.getElementById("OK").disabled = false;
                    } else {
                        window.alert("Неверный формат адреса");
                    }
                }
            );
        }

    </script>
</head>
<body>
<script>
    function getTodaysDate(){
        date = new Date();
        day = date.getDate();
        month = date.getMonth() + 1;
        month2 = date.getMonth() + 4;
        year = date.getFullYear();
        if (month < 10) month = "0" + month;
        if (month2 < 10) month2 = "0" + month2;
        if (day < 10) day = "0" + day;
        today = year + "-" + month + "-" + day;
        today2 = year + "-" + month2 + "-" + day;
        document.getElementById('targetDate').setAttribute('min', today);
        document.getElementById('targetDate').setAttribute('max', today2);
    }
</script>
<h1>Готовы принять ваш заказ!</h1>
<div class="order-form">
    <form action="/makeOrderAction" method="post">
        <div style="display:inline-block">
            <label> Откуда<a style="color:red">*</a> : <input type="text" name="addressFrom" id="addressFrom" th:value="${addressFrom_paste}"/> </label>
            <label> Куда<a style="color:red">*</a> : <input type="text" name="addressTo" id="addressTo" th:value="${addressTo_paste}"/> </label> <span style="color:red" th:text = "${addressFrom}" />
        </div>
        <div><label> Расстояние<a style="color:red">*</a> : <input type="text" name="distance" id="distance" th:value="${distance_paste}" readonly/> </label> <span style="color:red" th:text = "${distance}" /></div>
        <div><label> Длительность<a style="color:red">*</a> : <input type="text" name="duration" id="duration" th:value="${duration_paste}" readonly/> </label> <span style="color:red" th:text = "${duration}" /></div>
        <div><label> Дата<a style="color:red">*</a> : <input type="date" name="targetDate" id="targetDate" oninput="getTodaysDate()" th:value="${targetDate_paste}"/> </label> <span style="color:red" th:text = "${targetDate}" /></div>
        <div><label> Количесвто грузчиков<a style="color:red">*</a> : <input type="number" min="1" max="3" required id="numberOfWorkers" name="numberOfWorkers" th:value="${numberOfWorkers_paste}"/> </label> <span style="color:red" th:text = "${workers}" /></div>
        <div><label> Тип автомобиля<a style="color:red">*</a> :
        <select name="truckDescription">
            <option value="Жёсткий 4м/2.2м/2м Груз 1500кг" selected="selected">Жёсткий 4м/2.2м/2м Груз 1500кг</option>
            <option value="Тент 3м/1.5м/2м Груз 950кг">Тент 3м/1.5м/2м Груз 950кг</option>
            <option value="Жёсткий 1.6м/1м/1м Груз 500кг">Жёсткий 1.6м/1м/1м Груз 500кг</option>
        </select>
        </label> <span style="color:red" th:text = "${truck}" /></div>
        <div><label> Примерная цена<a style="color:red">*</a> : <input type="text" name="price" id="price" th:value="${price_paste}" readonly/> </label> <span style="color:red" th:text = "${price}" /></div>
        <div><input type="submit" id="OK" value="принять" disabled/></div>
    </form>
    <script
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBILU5tuxXgWHoI7KIOfUL5rk4JF98BPic&callback=initMap&libraries=&v=weekly&language=ru"
            async
    ></script>
    <div id="map"></div>
</div>
</body>
</html>